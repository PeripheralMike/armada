---
  Description: >-
    An AWS VPC with a subnet.
  AWSTemplateFormatVersion: 2010-09-09
  Resources:
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: 172.31.0.0/16
        EnableDnsSupport: true
        EnableDnsHostnames: true
        InstanceTenancy: default
    InternetGateway:
      Type: AWS::EC2::InternetGateway
    VPCGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
          VpcId: !Ref VPC
          InternetGatewayId: !Ref InternetGateway
    SubnetA:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 172.31.0.0/20
        MapPublicIpOnLaunch: true
    RouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
    InternetRoute:
      Type: AWS::EC2::Route
      DependsOn: VPCGatewayAttachment
      Properties:
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway
        RouteTableId: !Ref RouteTable
    SubnetARouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref RouteTable
        SubnetId: !Ref SubnetA
    SecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupName: "Armada Group"
        GroupDescription: "jmeter and SSH traffic in, all traffic out."
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: '22'
            ToPort: '22'
            CidrIp: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: '5000'
            ToPort: '5000'
            CidrIp: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: '6000'
            ToPort: '6000'
            CidrIp: 0.0.0.0/0
          - IpProtocol: tcp
            FromPort: '1099'
            ToPort: '1099'
            CidrIp: 0.0.0.0/0
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
    EC2Instance: 
      Type: AWS::EC2::Instance
      DependsOn: SubnetA
      DependsOn: VPC
      DependsOn: SecurityGroup
      Properties: 
        ImageId: "ami-07ee42ba0209b6d77"
        SubnetId: !Ref SubnetA
        SecurityGroupIds: 
          - !Ref SecurityGroup
        UserData : "IyEvYmluL2Jhc2gKIyBVc2VyIGRhdGEgZm9yIHRoZSBKbWV0ZXIgQXJtYWRhIHNlcnZlciBFQzIgaW5zdGFuY2Ugd2l0aGluIHRoZSBzcG90IGZsZWV0CiMgVGhpcyBpbmZvcm1hdGlvbiB3aWxsIGJlIGJhc2U2NCBlbmNvZGVkIGFuZCB1c2VkIGluIHRoZSAnY29uZmlnLmpzb24gZmlsZQoKCiMgc2V0IGlwIGFzIGVudiB2YXIgLSB0aGlzIGlzIGltcG9ydGFudCBmb3IgcnVubmluZyB0aGUgam1ldGVyIHRlc3RzIGluIGEgZGlzdHJpYnV0ZWQgc3R5bGUKZWNobyAiZXhwb3J0IExPQ0FMSVA9JChob3N0bmFtZSAtaSkiID4+IC9ldGMvYmFzaC5iYXNocmMKCnNvdXJjZSAvZXRjL2Jhc2guYmFzaHJjCgojIHVwZGF0ZSB0aGUgdWJ1bnR1IE9TCgpzdWRvIGFwdC1nZXQgdXBkYXRlIC15CgojIGluc3RhbGwgRG9ja2VyJ3MgY2VydGlmaWNhdGUuLi4KCnN1ZG8gYXB0LWdldCBpbnN0YWxsIFwKICAgIGFwdC10cmFuc3BvcnQtaHR0cHMgXAogICAgY2EtY2VydGlmaWNhdGVzIFwKICAgIGN1cmwgLXkgXAogICAgc29mdHdhcmUtcHJvcGVydGllcy1jb21tb24KCiMgYWRkIGRvY2tlcnMgb2ZmaWNpYWwgR1BHIGtleQpjdXJsIC1mc1NMIGh0dHBzOi8vZG93bmxvYWQuZG9ja2VyLmNvbS9saW51eC91YnVudHUvZ3BnIHwgc3VkbyBhcHQta2V5IGFkZCAtCgojIHNldCB1cCB0aGUgc3RhYmxlIHJlcG9zaXRvcnkKc3VkbyBhZGQtYXB0LXJlcG9zaXRvcnkgXAogICAiZGViIFthcmNoPWFtZDY0XSBodHRwczovL2Rvd25sb2FkLmRvY2tlci5jb20vbGludXgvdWJ1bnR1IFwKICAgJChsc2JfcmVsZWFzZSAtY3MpIFwKICAgc3RhYmxlIgoKIyB1cGRhdGUgYWdhaW4gbm93IHdpdGggYWRkZWQgcmVwbwpzdWRvIGFwdC1nZXQgdXBkYXRlIC15CgojIEluc3RhbGwgRG9ja2VyIENFIApzdWRvIGFwdC1nZXQgaW5zdGFsbCBkb2NrZXItY2UgLXkKCiMgaW5zdGFsbCBkb2NrZXItY29tcG9zZSAoaW4gY2FzZSB5b3UgbmVlZCB0byBtYWtlIGEgZG9ja2VyLWNvbXBvc2UgZmlsZSkKc3VkbyBhcHQtZ2V0IGluc3RhbGwgZG9ja2VyLWNvbXBvc2UgLXkKCiMgbWFrZSBkb2NrZXIgZ3JvdXAgaWYgbm90IGFscmVhZHkgY3JlYXRlZApzdWRvIGdyb3VwYWRkIGRvY2tlcgoKIyBtYWtlIHVidW50dSB1c2VyIHBhcnQgb2YgZG9ja2VyIGdyb3VwCnN1ZG8gdXNlcm1vZCAtYUcgZG9ja2VyIHVidW50dQoKIyBpbnN0YWxsIGh0b3AgKHRoaXMgaXMgZm9yIHN5c3RlbSBtb25pdG9yaW5nIC0gdG8gdXNlIGp1c3QgdHlwZSBpbiAnaHRvcCcgb24gdGhlIENMSSkKc3VkbyBhcHQgaW5zdGFsbCBodG9wCgo="
